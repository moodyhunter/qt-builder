name: Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  prepare:
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: windows-latest, setup: '' }
          - { os: macos-latest, setup: '' }
          - { os: ubuntu-latest }

    steps:
      - name: Get QtBuildScript
        run: |
          cd ~/
          git clone --verbose https://github.com/moodyhunter/QtBuildScript

      - name: Restore Caches
        uses: actions/cache@v3
        with:
          path: ~/QtBuildScript/.build-cache/
          key: ${{ runner.os }}-qt-cache

      - name: Setup Windows Environment
        if: runner.os == 'Windows'     
        uses: MinoruSekine/setup-scoop@main
        with:
          add_extras_bucket: true
 
      - name: Install Packages - Windows
        if: runner.os == 'Windows'
        run: |
          scoop install msys2 ninja sccache
          msys2

      - name: Install Packages - Linux
        if: runner.os == 'Linux'
        run: |
          export DISTRO=$(lsb_release -sc)
          echo "deb http://archive.ubuntu.com/ubuntu/ $DISTRO main universe" | sudo tee -a /etc/apt/sources.list
          echo "deb-src http://archive.ubuntu.com/ubuntu/ $DISTRO main universe" | sudo tee -a /etc/apt/sources.list
          sudo apt update
          sudo apt upgrade -y
          sudo apt-get build-dep qt6-base-dev

      - name: Install Packages - macOS
        if: runner.os == 'macOS'
        run: |
          brew install fish ninja

      - name: nice
        shell: bash
        run: |
          cd ~/QtBuildScript
          echo 'sccache' > .base-kits
          echo 'shared' >> .base-kits
          echo 'release' >> .base-kits
          echo 'tests' >> .base-kits
          echo 'examples' >> .base-kits
          ${{ matrix.config.setup }}
